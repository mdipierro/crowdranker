<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <meta http-equiv="P3P" content="CP=\"IDC DSP COR CURa ADMa OUR IND PHY ONL COM STA\"" />
        <title>edit tagstore/controllers/default.py</title>
        
        <script type="text/javascript"><!--
    // These variables are used by the web2py_ajax_init function in web2py_ajax.js (which is loaded below).
    var w2p_ajax_confirm_message = "Are you sure you want to delete this object?";
    var w2p_ajax_date_format = "%m-%d-%Y";
    var w2p_ajax_datetime_format = "%m-%d-%Y %H:%M:%S";
    //--></script>
<script src="/admin/static/js/jquery.js" type="text/javascript"></script><link href="/admin/static/css/calendar.css" rel="stylesheet" type="text/css" /><script src="/admin/static/js/calendar.js" type="text/javascript"></script><script src="/admin/static/js/web2py.js" type="text/javascript"></script><script src="/admin/static/plugin_multiselect/jquery.multi-select.js" type="text/javascript"></script><link href="/admin/static/plugin_multiselect/multi-select.css" rel="stylesheet" type="text/css" /><script src="/admin/static/plugin_multiselect/start.js" type="text/javascript"></script><link href="/admin/static/css/styles.css" rel="stylesheet" type="text/css" />

        <script>jQuery.noConflict();</script>
    </head>
    <body class=" edit">
        <div id="header">
          <h1 id="start">
            <a href="/admin/default/index" class="button"><span>web2py&trade; administrative interface</span></a>
          </h1>
          
          <ul id="menu">
              
              <li><a class="button" href="/admin/default/site"><span>Site</span></a></li>
              
              <li><a class="button" href="/admin/default/design/tagstore"><span>Edit</span></a></li>
              
              <li><a class="button" href="/admin/default/about/tagstore"><span>About</span></a></li>
              
              <li><a class="button" href="/admin/default/errors/tagstore"><span>Errors</span></a></li>
              
              <li><a class="button" href="/admin/mercurial/commit/tagstore"><span>Versioning</span></a></li>
              
              <li><a class="button" href="/admin/default/logout"><span>Logout</span></a></li>
              
              <li><a class="button" href="/admin/debug/interact"><span>Debug</span></a></li>
              
              <li><a class="button" href="/examples/default/index"><span>Help</span></a></li>
              
          </ul>
          
        </div>
        <div id="main">
            <div id="main_inner">
                <div class="flash"></div>
                




<link rel="stylesheet" href="/admin/static/codemirror/lib/codemirror.css">
<link rel="stylesheet" href="/admin/static/codemirror/theme/web2py.css">
<script src="/admin/static/codemirror/lib/codemirror.js"></script>
<script src="/admin/static/codemirror/mode/clike/clike.js"></script>


<script src="/admin/static/codemirror/mode/python/python.js"></script>
<script src="/admin/static/codemirror/mode/xml/xml.js"></script>
<script src="/admin/static/codemirror/mode/css/css.js"></script>
<script src="/admin/static/codemirror/mode/javascript/javascript.js"></script>
<script src="/admin/static/codemirror/mode/htmlmixed/htmlmixed.js"></script>
<script src="/admin/static/codemirror/lib/util/search.js"></script>
<script src="/admin/static/codemirror/lib/util/searchcursor.js"></script>
<script src="/admin/static/codemirror/lib/util/dialog.js"></script>
<link rel="stylesheet" href="/admin/static/codemirror/lib/util/dialog.css">
<script src="/admin/static/codemirror/emmet.min.js"></script>
<script language="Javascript" type="text/javascript" src="/admin/static/js/ajax_editor.js"></script>




<h2>Editing file "tagstore/controllers/default.py"</h2>


  <p class="formfield">
<span style="text-align:left;" id="exposed">
  <b>exposes:</b> <a href="/tagstore/default/index">index</a>, <a href="/tagstore/default/user">user</a>, <a href="/tagstore/default/download">download</a>, <a href="/tagstore/default/call">call</a>, <a href="/tagstore/default/data">data</a>, <a href="/tagstore/default/add_tagging">add_tagging</a>, <a href="/tagstore/default/get_tags">get_tags</a>, <a href="/tagstore/default/set_nickname">set_nickname</a>
</span>
  <br/>
  <b>edit views:</b>
  <a href="/admin/default/edit/tagstore/views/default/user.html">user</a>, <a href="/admin/default/edit/tagstore/views/default/index.html">index</a>
  
  </p>


<p class="right controls">
  
      <a class="button special" name="breakpoint" onclick="return doToggleBreakpoint(&#x27;tagstore/controllers/default.py&#x27;,&#x27;https://crowdlab.soe.ucsc.edu/admin/debug/toggle_breakpoint&#x27;);" value="breakpoint"><span>toggle breakpoint</span></a>
    
  <a class="button" href="/admin/default/design/tagstore#controllers__default__py"><span>&lt;&lt;back</span></a>
  
  
  
  <a class="button" href="http://www.web2py.com/examples/static/epydoc/index.html" target="_blank"><span>docs</span></a>
</p>

<div id="editor_area">
  <form action="/admin/default/edit/tagstore/controllers/default.py" method="post" name="editform" id="editform">
    <a value="save" name="save" onclick="return doClickSave();" class="icon saveicon">
      <img alt="Save" src="/admin/static/images/save_icon.png" />
    </a>
    Saved file hash:
    <input type="input" name="file_hash" value="0366a747fa170d36b02803fb5b4b1a9d" readonly="readonly"/>
    Last saved on: <input type="input" name="saved_on" value="Thu Feb 14 20:36:33 2013" readonly="readonly"/>
    <br><hr>
    
    <textarea style="width: auto; height:auto; direction:ltr;" id="body" name="data"># -*- coding: utf-8 -*-
# this file is released under public domain and you can use without limitations

#########################################################################
## This is a samples controller
## - index is the default action of any application
## - user is required for authentication and authorization
## - download is for downloading files uploaded in the db (does streaming)
## - call exposes all registered services (none by default)
#########################################################################


def index():
    &quot;&quot;&quot;
    example action using the internationalization operator T and flash
    rendered by views/default/index.html or views/generic.html

    if you need a simple wiki simple replace the two lines below with:
    return auth.wiki()
    &quot;&quot;&quot;
    response.flash = T(&quot;Welcome to web2py!&quot;)
    return dict(message=T(&#x27;Hello World&#x27;))


def user():
    &quot;&quot;&quot;
    exposes:
    http://..../[app]/default/user/login
    http://..../[app]/default/user/logout
    http://..../[app]/default/user/register
    http://..../[app]/default/user/profile
    http://..../[app]/default/user/retrieve_password
    http://..../[app]/default/user/change_password
    use @auth.requires_login()
        @auth.requires_membership(&#x27;group name&#x27;)
        @auth.requires_permission(&#x27;read&#x27;,&#x27;table name&#x27;,record_id)
    to decorate functions that need access control
    &quot;&quot;&quot;
    return dict(form=auth())


def download():
    &quot;&quot;&quot;
    allows downloading of uploaded files
    http://..../[app]/default/download/[filename]
    &quot;&quot;&quot;
    return response.download(request, db)


def call():
    &quot;&quot;&quot;
    exposes services. for example:
    http://..../[app]/default/call/jsonrpc
    decorate with @services.jsonrpc the functions to expose
    supports xml, json, xmlrpc, jsonrpc, amfrpc, rss, csv
    &quot;&quot;&quot;
    return service()


@auth.requires_signature()
def data():
    &quot;&quot;&quot;
    http://..../[app]/default/data/tables
    http://..../[app]/default/data/create/[table]
    http://..../[app]/default/data/read/[table]/[id]
    http://..../[app]/default/data/update/[table]/[id]
    http://..../[app]/default/data/delete/[table]/[id]
    http://..../[app]/default/data/select/[table]
    http://..../[app]/default/data/search/[table]
    but URLs must be signed, i.e. linked with
      A(&#x27;table&#x27;,_href=URL(&#x27;data/tables&#x27;,user_signature=True))
    or with the signed load operator
      LOAD(&#x27;default&#x27;,&#x27;data.load&#x27;,args=&#x27;tables&#x27;,ajax=True,user_signature=True)
    &quot;&quot;&quot;
    return dict(form=crud())


def add_tagging():
    lat = request.vars.latitude
    lng = request.vars.longitude
    token = request.vars.token
    user = request.vars.user
    tag = request.vars.tag
    # Checks the token.
    if token != SECRET_TOKEN:
        raise HTTP(403, &quot;Authorization Failed.&quot;)
    # Gets the tag id.
    user_id = get_user(user)
    tag_id = add_tag(tag)
    # Inserts the tag.
    tagging_id = db.tagging.insert(
        latitude = lat, longitude = lng, user_id = user_id, 
        tag = tag_id)
    db.commit()
    return dict(id=tagging_id)
    
def add_tag(tag):
    t = db(db.tag.name == tag).select().first()
    if t == None:
        id = db.tag.insert(name = tag, count = 1,
            rank = 1.0, rank_update_time = datetime.utcnow())
        return id
    else:
        id = t.id
        t.cnt = t.cnt + 1
        t.tagrank = 1.0 + t.tagrank
        return id
    

def get_tags():
    lat_min = request.vars.lat_min
    lat_max = request.vars.lat_max
    lng_min = request.vars.lng_min
    lng_max = request.vars.lng_max
    n_taggings = request.vars.n_taggings
    token = request.vars.token
    # Checks the token.
    if token != SECRET_TOKEN:
        raise HTTP(403, &quot;Authorization Failed.&quot;)
    r = db((db.tagging.latitude &gt;= lat_min) &amp;
           (db.tagging.latitude &lt;= lat_max) &amp;
           (db.tagging.longitude &gt;= lng_min) &amp;
           (db.tagging.longitude &lt;= lng_max)).select(
               orderby=~db.tagging.created_on,limitby=(0,n_taggings))
    rr = []
    for el in r:
        rr.append({
            &#x27;lat&#x27;: r.latitude,
            &#x27;lng&#x27;: r.longitude,
            &#x27;tag&#x27;: get_tag_name(r.tag),
            &#x27;nick&#x27;: get_nickname(r.user_id)
            })
    return dict(tags=rr)
        
def get_tag_name(tag_id):
    t = db.tag(tag_id)
    if t == None:
        return &#x27;--unnamed--&#x27;
    else:
        return t.name
        
def get_nickname(user_id):
    u = db.appuser(user_id)
    if u == None:
        return &#x27;anon&#x27;
    else:
        return u.nick
        

def set_nickname():
    user = request.vars.user
    nick = request.vars.nick
    token = request.vars.token
    # Checks the token.
    if token != SECRET_TOKEN:
        raise HTTP(403, &quot;Authorization Failed.&quot;)
    # db.appuser.insert_or_update(username = user, nick = nick)
    db.commit()
    return dict(nick=nick)
    


# def get_popular_tags():
</textarea>
    <script>
      function isFullScreen(instance) {
          return /\bCodeMirror-fullscreen\b/.test(instance.getWrapperElement().className);
      }
      function winHeight() {
          return window.innerHeight || (document.documentElement || document.body).clientHeight;
      }
      function setFullScreen(instance, full) {
          var wrap = instance.getWrapperElement(), scroll = instance.getScrollerElement();
          if (full) {
              wrap.className += " CodeMirror-fullscreen";
              scroll.style.height = winHeight() + "px";
              document.documentElement.style.overflow = "hidden";
          } else {
              wrap.className = wrap.className.replace(" CodeMirror-fullscreen", "");
              scroll.style.height = "";
              document.documentElement.style.overflow = "";
          }
          instance.refresh();
      }
      CodeMirror.connect(window, "resize", function() {
          var showing = document.body.getElementsByClassName("CodeMirror-fullscreen")[0];
          if (!showing) return;
          showing.CodeMirror.getScrollerElement().style.height = winHeight() + "px";
      });
      // must be here or break emmet/zencoding
      CodeMirror.defaults.extraKeys["Ctrl-S"] = 
        function(instance) {doClickSave();};
      CodeMirror.defaults.extraKeys["Ctrl-F11"]= 
        function(instance) {
          setFullScreen(instance, !isFullScreen(instance));};
            
      CodeMirror.defaults.extraKeys["Tab"] = "indentMore";
      
      CodeMirror.defaults.extraKeys["Esc"]=
        function(instance) {
          if (isFullScreen(instance)) 
             setFullScreen(instance, false);};
      var cm_opts = {
        
          mode: { name: 'python',version: 2,singleLineStringErrors: false },
        
        lineNumbers: true,
        indentUnit: 4,
        theme: "web2py",
        tabMode: "shift",
        lineWrapping: true,
        
        
        matchBrackets: true,
        autofocus: true,
        onCursorActivity: function() {
            editor.setLineClass(hlLine, null, null);
            hlLine = editor.setLineClass(editor.getCursor().line, null, "activeline");}
      };
      var editor = CodeMirror.fromTextArea(
         document.getElementById("body"),cm_opts);
      var hlLine = editor.setLineClass(0, "activeline");
      window.mirror = editor;
      jQuery(function(){jQuery('.CodeMirror-scroll').css("height","auto").css("overflow-x","auto");});
    </script>
    
    <button class="editbutton" onclick="window.location.reload(); return false">restore</button> currently saved or <button class="editbutton" type="submit" name="revert">revert</button>
    to  previous version.
    <br/>
  </form>
</div>

<div class="help">
  
  <h3>Key bindings</h3>
  <ul>
    <li><tt>Ctrl+S</tt> Save via Ajax</li>
    <li><tt>Ctrl+F11</tt> Toggle Fullscreen</li>
    <li><tt>Ctrl-F / Cmd-F</tt> Start searching</li>
    <li><tt>Ctrl-G / Cmd-G</tt> Find Next</li>
    <li><tt>Shift-Ctrl-G / Shift-Cmd-G</tt> Find Previous</li>
    <li><tt>Shift-Ctrl-F / Cmd-Option-F</tt> Replace</li>
    <li><tt>Shift-Ctrl-R / Shift-Cmd-Option-F</tt> Replace All</li>
  </ul>
  
</div>

            </div>
        </div>
        <div id="footer" class="fixed">
            Powered by <a href="http://www.web2py.com">web2py</a>&trade; created by Massimo Di Pierro &copy;2007-2013 -
        
        <span>
          Admin language
          <select name="adminlanguage" onchange="var date = new Date();cookieDate=date.setTime(date.getTime()+(100*24*60*60*1000));document.cookie='adminLanguage='+this.options[this.selectedIndex].id+'; expires='+cookieDate+'; path=/';window.location.reload()">
          
            <option  id=af >Afrikaanse</option>
          
            <option  id=bg >Български</option>
          
            <option  id=de >Deutsch</option>
          
            <option selected id=en-us >English (US)</option>
          
            <option  id=es >Español</option>
          
            <option  id=fr >Français</option>
          
            <option  id=he >עברית</option>
          
            <option  id=it >Italiano</option>
          
            <option  id=ja >日本語</option>
          
            <option  id=nl >Nederlands</option>
          
            <option  id=pl >Polska</option>
          
            <option  id=pt >Português</option>
          
            <option  id=ro >Română</option>
          
            <option  id=ru >Русский</option>
          
            <option  id=sl >Slovenski</option>
          
            <option  id=uk >Українська</option>
          
            <option  id=zh >中文</option>
          
            <option  id=zh-tw >台灣中文</option>
          
          </select>
        </span>
        
        </div>
    </body>
</html>
